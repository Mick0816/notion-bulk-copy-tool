import streamlit as st
from notion_client import Client
import json
from datetime import datetime
import pickle
import os
from concurrent.futures import ThreadPoolExecutor, as_completed
import hashlib

# „Éö„Éº„Ç∏Ë®≠ÂÆö
st.set_page_config(
    page_title="Notion‰∏ÄÊã¨„Ç≥„Éî„Éº„ÉÑ„Éº„É´",
    page_icon="üìù",
    layout="wide"
)

# „Ç≠„É£„ÉÉ„Ç∑„É•„Éá„Ç£„É¨„ÇØ„Éà„É™
CACHE_DIR = ".notion_cache"
CONFIG_FILE = os.path.join(CACHE_DIR, "config.json")

if not os.path.exists(CACHE_DIR):
    os.makedirs(CACHE_DIR)

# „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„ÅÆÂàùÊúüÂåñ
if 'pages_data' not in st.session_state:
    st.session_state.pages_data = []
if 'selected_pages' not in st.session_state:
    st.session_state.selected_pages = set()
if 'filter_options' not in st.session_state:
    st.session_state.filter_options = {'categories': [], 'db_tags': []}
if 'select_all_checkbox' not in st.session_state:
    st.session_state.select_all_checkbox = False
if 'notion_token' not in st.session_state:
    st.session_state.notion_token = ""
if 'database_id' not in st.session_state:
    st.session_state.database_id = ""

def save_config(token, db_id):
    """Ë®≠ÂÆö„Çí‰øùÂ≠ò"""
    config = {
        'notion_token': token,
        'database_id': db_id
    }
    with open(CONFIG_FILE, 'w') as f:
        json.dump(config, f)

def load_config():
    """Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø"""
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r') as f:
                config = json.load(f)
            return config.get('notion_token', ''), config.get('database_id', '')
        except:
            return '', ''
    return '', ''

# Ëµ∑ÂãïÊôÇ„Å´Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
if st.session_state.notion_token == "" and st.session_state.database_id == "":
    loaded_token, loaded_db_id = load_config()
    st.session_state.notion_token = loaded_token
    st.session_state.database_id = loaded_db_id

def init_page_checkboxes():
    """„Éö„Éº„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÂàùÊúüÂåñ"""
    for page in st.session_state.pages_data:
        checkbox_key = f'page_check_{page["id"]}'
        if checkbox_key not in st.session_state:
            # ÂàùÊúüÂÄ§„ÇíÊòéÁ§∫ÁöÑ„Å´Ë®≠ÂÆö
            st.session_state[checkbox_key] = False

def changed_page_checkboxes_by_select_all():
    """ÂÖ®„Å¶ÈÅ∏Êäû„ÇíTrue„Å´„Åó„ÅüÂ†¥Âêà„ÄÅÈÅ∏Êäû„Éú„Çø„É≥„Çí„Åô„Åπ„Å¶True„Å´„Åô„Çã"""
    if st.session_state.select_all_checkbox:
        for page in st.session_state.pages_data:
            checkbox_key = f'page_check_{page["id"]}'
            st.session_state[checkbox_key] = True
            st.session_state.selected_pages.add(page['id'])
    else:
        pass

def changed_select_all_by_page_checkboxes():
    """ÈÅ∏Êäû„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„Å´Âøú„Åò„Å¶ÂÖ®„Å¶ÈÅ∏Êäû„ÇíÊõ¥Êñ∞"""
    all_checked = True
    any_checked = False
    
    for page in st.session_state.pages_data:
        checkbox_key = f'page_check_{page["id"]}'
        if checkbox_key in st.session_state:
            if st.session_state[checkbox_key]:
                any_checked = True
                st.session_state.selected_pages.add(page['id'])
            else:
                all_checked = False
                st.session_state.selected_pages.discard(page['id'])
    
    if all_checked and len(st.session_state.pages_data) > 0:
        st.session_state.select_all_checkbox = True
    else:
        st.session_state.select_all_checkbox = False

def get_cache_path(database_id, filters):
    """„Ç≠„É£„ÉÉ„Ç∑„É•„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ„ÇíÁîüÊàê"""
    filter_hash = hashlib.md5(str(filters).encode()).hexdigest()
    return os.path.join(CACHE_DIR, f"cache_{database_id}_{filter_hash}.pkl")

def save_cache(database_id, filters, data):
    """„Ç≠„É£„ÉÉ„Ç∑„É•„Çí‰øùÂ≠ò"""
    cache_path = get_cache_path(database_id, filters)
    cache_data = {
        'timestamp': datetime.now(),
        'data': data
    }
    with open(cache_path, 'wb') as f:
        pickle.dump(cache_data, f)

def load_cache(database_id, filters):
    """„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíË™≠„ÅøËæº„Åø"""
    cache_path = get_cache_path(database_id, filters)
    if os.path.exists(cache_path):
        try:
            with open(cache_path, 'rb') as f:
                cache_data = pickle.load(f)
            return cache_data
        except:
            return None
    return None

def extract_text_from_blocks(blocks):
    """„Éñ„É≠„ÉÉ„ÇØ„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫"""
    text_content = []
    
    for block in blocks:
        block_type = block.get('type')
        
        if block_type == 'paragraph':
            rich_text = block.get('paragraph', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(text)
        
        elif block_type == 'heading_1':
            rich_text = block.get('heading_1', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(f"\n# {text}\n")
        
        elif block_type == 'heading_2':
            rich_text = block.get('heading_2', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(f"\n## {text}\n")
        
        elif block_type == 'heading_3':
            rich_text = block.get('heading_3', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(f"\n### {text}\n")
        
        elif block_type == 'bulleted_list_item':
            rich_text = block.get('bulleted_list_item', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(f"‚Ä¢ {text}")
        
        elif block_type == 'numbered_list_item':
            rich_text = block.get('numbered_list_item', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(f"1. {text}")
        
        elif block_type == 'code':
            rich_text = block.get('code', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            language = block.get('code', {}).get('language', '')
            if text:
                text_content.append(f"```{language}\n{text}\n```")
        
        elif block_type == 'quote':
            rich_text = block.get('quote', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(f"> {text}")
        
        elif block_type == 'toggle':
            rich_text = block.get('toggle', {}).get('rich_text', [])
            text = ''.join([t.get('plain_text', '') for t in rich_text])
            if text:
                text_content.append(f"‚ñ∏ {text}")
    
    return '\n'.join(text_content)

def get_page_content(notion, page_id):
    """„Éö„Éº„Ç∏„ÅÆÂÜÖÂÆπ„ÇíÂèñÂæó"""
    try:
        page = notion.pages.retrieve(page_id=page_id)
        
        title = "ÁÑ°È°å"
        if 'properties' in page:
            for prop_name, prop_value in page['properties'].items():
                if prop_value.get('type') == 'title':
                    title_list = prop_value.get('title', [])
                    if title_list:
                        title = ''.join([t.get('plain_text', '') for t in title_list])
                    break
        
        blocks = []
        has_more = True
        start_cursor = None
        
        while has_more:
            if start_cursor:
                response = notion.blocks.children.list(
                    block_id=page_id,
                    start_cursor=start_cursor
                )
            else:
                response = notion.blocks.children.list(block_id=page_id)
            
            blocks.extend(response.get('results', []))
            has_more = response.get('has_more', False)
            start_cursor = response.get('next_cursor')
        
        content = extract_text_from_blocks(blocks)
        
        return {
            'id': page_id,
            'title': title,
            'content': content,
            'char_count': len(content),
            'line_count': len(content.split('\n'))
        }
    
    except Exception as e:
        return None

def get_filter_options(notion, database_id):
    """„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„Çâ„Éï„Ç£„É´„Çø„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂèñÂæó"""
    try:
        database = notion.databases.retrieve(database_id=database_id)
        properties = database.get('properties', {})
        
        options = {'categories': [], 'db_tags': []}
        
        if '„Ç´„ÉÜ„Ç¥„É™' in properties:
            prop = properties['„Ç´„ÉÜ„Ç¥„É™']
            if prop.get('type') == 'select':
                select_options = prop.get('select', {}).get('options', [])
                options['categories'] = [opt.get('name') for opt in select_options]
            elif prop.get('type') == 'multi_select':
                select_options = prop.get('multi_select', {}).get('options', [])
                options['categories'] = [opt.get('name') for opt in select_options]
        
        if 'DB_tag' in properties:
            prop = properties['DB_tag']
            prop_type = prop.get('type')
            
            if prop_type == 'select':
                select_options = prop.get('select', {}).get('options', [])
                options['db_tags'] = [opt.get('name') for opt in select_options]
            elif prop_type == 'multi_select':
                select_options = prop.get('multi_select', {}).get('options', [])
                options['db_tags'] = [opt.get('name') for opt in select_options]
            elif prop_type == 'relation':
                relation_db_id = prop.get('relation', {}).get('database_id')
                if relation_db_id:
                    relation_pages = []
                    has_more = True
                    start_cursor = None
                    
                    while has_more:
                        if start_cursor:
                            response = notion.databases.query(
                                database_id=relation_db_id,
                                start_cursor=start_cursor
                            )
                        else:
                            response = notion.databases.query(database_id=relation_db_id)
                        
                        for page in response.get('results', []):
                            page_props = page.get('properties', {})
                            for prop_name, prop_value in page_props.items():
                                if prop_value.get('type') == 'title':
                                    title_list = prop_value.get('title', [])
                                    if title_list:
                                        title = ''.join([t.get('plain_text', '') for t in title_list])
                                        if title:
                                            relation_pages.append(title)
                                    break
                        
                        has_more = response.get('has_more', False)
                        start_cursor = response.get('next_cursor')
                    
                    options['db_tags'] = sorted(list(set(relation_pages)))
        
        return options
    except Exception as e:
        st.error(f"„Éï„Ç£„É´„Çø„Ç™„Éó„Ç∑„Éß„É≥ÂèñÂæó„Ç®„É©„Éº: {str(e)}")
        return {'categories': [], 'db_tags': []}

def build_filter_query(selected_categories, selected_db_tags):
    """Notion API„Éï„Ç£„É´„Çø„ÇØ„Ç®„É™„ÇíÊßãÁØâ"""
    filters = []
    
    if selected_categories:
        if len(selected_categories) == 1:
            filters.append({
                "property": "„Ç´„ÉÜ„Ç¥„É™",
                "select": {"equals": selected_categories[0]}
            })
        else:
            category_filters = [
                {"property": "„Ç´„ÉÜ„Ç¥„É™", "select": {"equals": cat}}
                for cat in selected_categories
            ]
            filters.append({"or": category_filters})
    
    if selected_db_tags:
        if len(selected_db_tags) == 1:
            filters.append({
                "property": "DB_tag",
                "relation": {"contains": selected_db_tags[0]}
            })
        else:
            tag_filters = [
                {"property": "DB_tag", "relation": {"contains": tag}}
                for tag in selected_db_tags
            ]
            filters.append({"or": tag_filters})
    
    if len(filters) == 0:
        return None
    elif len(filters) == 1:
        return filters[0]
    else:
        return {"and": filters}

def load_database_pages(notion, database_id, filter_query=None, use_cache=True):
    """„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂÖ®„Éö„Éº„Ç∏„Çí‰∏¶ÂàóÂèñÂæó"""
    try:
        if use_cache:
            cached = load_cache(database_id, filter_query)
            if cached:
                cache_time = cached['timestamp'].strftime("%Y-%m-%d %H:%M:%S")
                st.info(f"üì¶ „Ç≠„É£„ÉÉ„Ç∑„É•„Çí‰ΩøÁî® (ÂèñÂæóÊó•ÊôÇ: {cache_time})")
                return cached['data']
        
        page_ids = []
        has_more = True
        start_cursor = None
        
        with st.spinner('„Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂèñÂæó‰∏≠...'):
            while has_more:
                query_params = {"database_id": database_id}
                
                if filter_query:
                    query_params["filter"] = filter_query
                
                if start_cursor:
                    query_params["start_cursor"] = start_cursor
                
                response = notion.databases.query(**query_params)
                
                for page in response.get('results', []):
                    page_ids.append(page['id'])
                
                has_more = response.get('has_more', False)
                start_cursor = response.get('next_cursor')
        
        if len(page_ids) == 0:
            st.warning("‚ö†Ô∏è „Éï„Ç£„É´„ÇøÊù°‰ª∂„Å´‰∏ÄËá¥„Åô„Çã„Éö„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü")
            return []
        
        pages_data = []
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        with ThreadPoolExecutor(max_workers=5) as executor:
            future_to_id = {
                executor.submit(get_page_content, notion, page_id): page_id 
                for page_id in page_ids
            }
            
            completed = 0
            total = len(page_ids)
            
            for future in as_completed(future_to_id):
                page_content = future.result()
                if page_content:
                    pages_data.append(page_content)
                
                completed += 1
                progress_bar.progress(completed / total)
                status_text.text(f"Ë™≠„ÅøËæº„Åø‰∏≠: {completed}/{total} „Éö„Éº„Ç∏")
        
        progress_bar.empty()
        status_text.empty()
        
        save_cache(database_id, filter_query, pages_data)
        
        return pages_data
    
    except Exception as e:
        st.error(f"„Éá„Éº„Çø„Éô„Éº„ÇπË™≠„ÅøËæº„Åø„Ç®„É©„Éº: {str(e)}")
        return []

# „É°„Ç§„É≥UI
st.title("üìù Notion‰∏ÄÊã¨„Ç≥„Éî„Éº„ÉÑ„Éº„É´")
st.markdown("---")

# „Çµ„Ç§„Éâ„Éê„Éº: Ë®≠ÂÆö
with st.sidebar:
    st.header("‚öôÔ∏è Ë®≠ÂÆö")
    
    notion_token = st.text_input(
        "Notion API Token",
        value=st.session_state.notion_token,
        type="password",
        help="Notion„Ç§„É≥„ÉÜ„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÅÆ„Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ"
    )
    
    database_id = st.text_input(
        "„Éá„Éº„Çø„Éô„Éº„ÇπID",
        value=st.session_state.database_id,
        help="Notion„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆID„ÇíÂÖ•Âäõ"
    )
    
    if notion_token != st.session_state.notion_token or database_id != st.session_state.database_id:
        st.session_state.notion_token = notion_token
        st.session_state.database_id = database_id
        if notion_token and database_id:
            save_config(notion_token, database_id)
    
    if st.button("üîç „Éï„Ç£„É´„ÇøË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø", use_container_width=True):
        if not notion_token or not database_id:
            st.error("API Token„Å®„Éá„Éº„Çø„Éô„Éº„ÇπID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
        else:
            try:
                with st.spinner('„Éï„Ç£„É´„ÇøË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø‰∏≠...'):
                    notion = Client(auth=notion_token)
                    st.session_state.filter_options = get_filter_options(notion, database_id)
                st.success("‚úÖ „Éï„Ç£„É´„ÇøË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü!")
            except Exception as e:
                st.error(f"‚ùå „Ç®„É©„Éº: {str(e)}")
    
    st.markdown("---")
    st.subheader("üìã „Éï„Ç£„É´„ÇøÊù°‰ª∂")
    
    selected_categories = []
    if st.session_state.filter_options['categories']:
        # „Åô„Åπ„Å¶ÈÅ∏Êäû„Éú„Çø„É≥Ôºà„Ç´„ÉÜ„Ç¥„É™Ôºâ
        if st.button("‚úÖ „Ç´„ÉÜ„Ç¥„É™: „Åô„Åπ„Å¶ÈÅ∏Êäû", use_container_width=True, key="select_all_categories"):
            # „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„Å´‰øùÂ≠ò„Åó„Å¶„ÄÅ„Éó„É´„ÉÄ„Ç¶„É≥„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§„Å®„Åó„Å¶‰ΩøÁî®
            st.session_state['selected_categories_default'] = st.session_state.filter_options['categories']
            st.rerun()
        
        # „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆË®≠ÂÆö
        default_categories = st.session_state.get('selected_categories_default', [])
        
        selected_categories = st.multiselect(
            "„Ç´„ÉÜ„Ç¥„É™",
            options=st.session_state.filter_options['categories'],
            default=default_categories,
            help="Ë§áÊï∞ÈÅ∏ÊäûÂèØËÉΩ(ORÊù°‰ª∂)"
        )
        
        # ÈÅ∏Êäû„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Çâ„Éá„Éï„Ç©„É´„ÉàÂÄ§„Çí„ÇØ„É™„Ç¢
        if selected_categories != default_categories:
            st.session_state['selected_categories_default'] = selected_categories
    else:
        st.caption("„Éï„Ç£„É´„ÇøË®≠ÂÆö„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ")
    
    selected_db_tags = []
    if st.session_state.filter_options['db_tags']:
        # „Åô„Åπ„Å¶ÈÅ∏Êäû„Éú„Çø„É≥ÔºàDB_tagÔºâ
        if st.button("‚úÖ DB_tag: „Åô„Åπ„Å¶ÈÅ∏Êäû", use_container_width=True, key="select_all_db_tags"):
            # „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„Å´‰øùÂ≠ò„Åó„Å¶„ÄÅ„Éó„É´„ÉÄ„Ç¶„É≥„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§„Å®„Åó„Å¶‰ΩøÁî®
            st.session_state['selected_db_tags_default'] = st.session_state.filter_options['db_tags']
            st.rerun()
        
        # „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆË®≠ÂÆö
        default_db_tags = st.session_state.get('selected_db_tags_default', [])
        
        selected_db_tags = st.multiselect(
            "DB_tag",
            options=st.session_state.filter_options['db_tags'],
            default=default_db_tags,
            help="Ë§áÊï∞ÈÅ∏ÊäûÂèØËÉΩ(ORÊù°‰ª∂)"
        )
        
        # ÈÅ∏Êäû„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Çâ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíÊõ¥Êñ∞
        if selected_db_tags != default_db_tags:
            st.session_state['selected_db_tags_default'] = selected_db_tags
    
    st.markdown("---")
    
    use_cache = st.checkbox("„Ç≠„É£„ÉÉ„Ç∑„É•„Çí‰ΩøÁî®", value=True, help="ÂâçÂõû„ÅÆË™≠„ÅøËæº„ÅøÁµêÊûú„ÇíÂÜçÂà©Áî®")
    
    if st.button("üîÑ „Éö„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø", use_container_width=True, type="primary"):
        if not notion_token or not database_id:
            st.error("API Token„Å®„Éá„Éº„Çø„Éô„Éº„ÇπID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
        else:
            try:
                notion = Client(auth=notion_token)
                filter_query = build_filter_query(selected_categories, selected_db_tags)
                st.session_state.pages_data = load_database_pages(
                    notion, 
                    database_id, 
                    filter_query,
                    use_cache
                )
                st.session_state.selected_pages = set()
                st.success(f"‚úÖ {len(st.session_state.pages_data)}‰ª∂„ÅÆ„Éö„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü!")
            except Exception as e:
                st.error(f"„Ç®„É©„Éº: {str(e)}")
    
    if st.button("üóëÔ∏è „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢", use_container_width=True):
        import shutil
        if os.path.exists(CACHE_DIR):
            shutil.rmtree(CACHE_DIR)
            os.makedirs(CACHE_DIR)
            st.success("„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü!")
    
    st.markdown("---")
    st.markdown(f"**Ë™≠„ÅøËæº„ÅøÊ∏à„Åø:** {len(st.session_state.pages_data)}‰ª∂")
    st.markdown(f"**ÈÅ∏Êäû‰∏≠:** {len(st.session_state.selected_pages)}‰ª∂")

# „É°„Ç§„É≥„Ç®„É™„Ç¢
if len(st.session_state.pages_data) == 0:
    st.info("üëà „Çµ„Ç§„Éâ„Éê„Éº„Åã„Çâ„Éï„Ç£„É´„ÇøË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„ÄÅ„Éö„Éº„Ç∏„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
    
    with st.expander("üìñ ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ"):
        st.markdown("""
        ### „Çπ„ÉÜ„ÉÉ„Éó1: ÂàùÊúüË®≠ÂÆö
        1. Notion API Token„ÇíÂÖ•Âäõ
        2. „Éá„Éº„Çø„Éô„Éº„ÇπID„ÇíÂÖ•Âäõ
        3. „Äå„Éï„Ç£„É´„ÇøË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ
        
        ### „Çπ„ÉÜ„ÉÉ„Éó2: „Éï„Ç£„É´„ÇøÊù°‰ª∂„ÇíË®≠ÂÆö
        1. „Ç´„ÉÜ„Ç¥„É™„ÇÑDB_tag„Åã„ÇâÁµû„ÇäËæº„ÅøÊù°‰ª∂„ÇíÈÅ∏Êäû
        2. „Äå„Éö„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ
        
        ### „Çπ„ÉÜ„ÉÉ„Éó3: „Éö„Éº„Ç∏„ÇíÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº
        1. Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„Åß„Åï„Çâ„Å´Áµû„ÇäËæº„Åø
        2. ÂøÖË¶Å„Å™„Éö„Éº„Ç∏„Å´„ÉÅ„Çß„ÉÉ„ÇØ
        3. „Äå„ÉÜ„Ç≠„Çπ„Éà„ÇíË°®Á§∫„Äç„Åæ„Åü„ÅØ„Äå„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò„Äç
        
        ### üí° Tips
        - **„Ç≠„É£„ÉÉ„Ç∑„É•Ê©üËÉΩ**: ‰∏ÄÂ∫¶Ë™≠„ÅøËæº„Çì„Å†„Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åï„Çå„ÄÅÊ¨°Âõû„ÅØÈ´òÈÄü„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
        - **‰∏¶ÂàóÂá¶ÁêÜ**: Ë§áÊï∞„Éö„Éº„Ç∏„ÇíÂêåÊôÇ„Å´ÂèñÂæó„Åô„Çã„Åü„ÇÅ„ÄÅÂ§ßÈáè„ÅÆ„Éö„Éº„Ç∏„ÇÇÁ¥†Êó©„ÅèË™≠„ÅøËæº„ÇÅ„Åæ„Åô
        - **„Éï„Ç£„É´„Çø**: ÂøÖË¶Å„Å™„Éö„Éº„Ç∏„Å†„Åë„ÇíÂèñÂæó„Åô„Çã„Åì„Å®„Åß„ÄÅË™≠„ÅøËæº„ÅøÊôÇÈñì„ÇíÂ§ßÂπÖ„Å´Áü≠Á∏Æ„Åß„Åç„Åæ„Åô
        """)
else:
    col1, col2 = st.columns([7, 1])
    with col1:
        search_query = st.text_input(
            "üîç Ê§úÁ¥¢",
            placeholder="„Éö„Éº„Ç∏„Çø„Ç§„Éà„É´„Åæ„Åü„ÅØÊú¨Êñá„ÅßÊ§úÁ¥¢...",
            label_visibility="collapsed",
            key="search_box"
        )
    with col2:
        search_button = st.button("üîç Ê§úÁ¥¢", use_container_width=True)
    
    filtered_pages = st.session_state.pages_data
    if search_query:
        filtered_pages = [
            p for p in st.session_state.pages_data
            if search_query.lower() in p['title'].lower() or 
               search_query.lower() in p['content'].lower()
        ]
    
    init_page_checkboxes()
    
    col1, col2 = st.columns([1, 5])
    with col1:
        st.checkbox(
            "‚úÖ „Åô„Åπ„Å¶ÈÅ∏Êäû",
            value=st.session_state.select_all_checkbox,
            key='select_all_checkbox',
            on_change=changed_page_checkboxes_by_select_all
        )
    with col2:
        st.markdown(f"**Ë°®Á§∫‰∏≠:** {len(filtered_pages)}‰ª∂ / ÂÖ®{len(st.session_state.pages_data)}‰ª∂")
    
    st.markdown("---")
    
    for idx, page in enumerate(filtered_pages):
        col1, col2, col3 = st.columns([0.5, 6, 2])
        
        with col1:
            checkbox_key = f'page_check_{page["id"]}'
            
            st.checkbox(
                label=f"ÈÅ∏Êäû_{page['id']}",
                key=checkbox_key,
                label_visibility="collapsed",
                on_change=changed_select_all_by_page_checkboxes
            )
        
        with col2:
            st.markdown(f"**{page['title']}**")
            preview = page['content'][:100].replace('\n', ' ')
            st.caption(f"{preview}..." if len(page['content']) > 100 else preview)
        
        with col3:
            st.caption(f"üìÑ {page['line_count']}Ë°å / {page['char_count']}ÊñáÂ≠ó")
    
    st.markdown("---")
    col1, col2 = st.columns([2, 2])
    
    with col1:
        if st.button("üìÑ „ÉÜ„Ç≠„Çπ„Éà„ÇíË°®Á§∫", use_container_width=True, type="primary"):
            if len(st.session_state.selected_pages) == 0:
                st.warning("„Éö„Éº„Ç∏„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
            else:
                selected_content = []
                for page in st.session_state.pages_data:
                    if page['id'] in st.session_state.selected_pages:
                        selected_content.append(f"# {page['title']}\n\n{page['content']}")
                
                combined_text = "\n\n" + "="*80 + "\n\n".join(selected_content)
                
                st.text_area(
                    "‰ª•‰∏ã„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ (Ctrl+A ‚Üí Ctrl+C)",
                    combined_text,
                    height=300,
                    key="copy_area"
                )
                st.info("üí° „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢ÂÜÖ„Çí„ÇØ„É™„ÉÉ„ÇØ ‚Üí Ctrl+A(ÂÖ®ÈÅ∏Êäû) ‚Üí Ctrl+C(„Ç≥„Éî„Éº)")
    
    with col2:
        if st.button("üíæ „ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò", use_container_width=True):
            if len(st.session_state.selected_pages) == 0:
                st.warning("„Éö„Éº„Ç∏„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ")
            else:
                selected_content = []
                for page in st.session_state.pages_data:
                    if page['id'] in st.session_state.selected_pages:
                        selected_content.append(f"# {page['title']}\n\n{page['content']}")
                
                combined_text = "\n\n" + "="*80 + "\n\n".join(selected_content)
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                
                st.download_button(
                    label="‚¨áÔ∏è „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                    data=combined_text,
                    file_name=f"notion_pages_{timestamp}.txt",
                    mime="text/plain"
                )